name: Deploy to vltrngames.com

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allows manual triggering

env:
  DEPLOY_URL: vltrngames.com

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify deployment secrets
        run: |
          echo "Verifying deployment configuration..."
          if [ -z "${{ secrets.FTP_SERVER }}" ] || [ -z "${{ secrets.FTP_USERNAME }}" ] || [ -z "${{ secrets.FTP_PASSWORD }}" ]; then
            echo "‚ùå ERROR: Missing FTP credentials!"
            echo "Required secrets:"
            echo "  - FTP_SERVER (your FTP hostname)"
            echo "  - FTP_USERNAME (your FTP username)"
            echo "  - FTP_PASSWORD (your FTP password)"
            echo ""
            echo "Add these at: https://github.com/VltrnOne/vltrn-games/settings/secrets/actions"
            exit 1
          fi
          echo "‚úÖ FTP credentials configured"
          echo "Server: ${{ secrets.FTP_SERVER }}"
          echo "Username: ${{ secrets.FTP_USERNAME }}"

      - name: Build All Games from Repo
        run: |
          echo "üèóÔ∏è  Building VLTRN Games from repository..."
          echo "   (Same process as other games - builds from repo, deploys automatically)"
          echo ""

          # Build Lil J's Castle
          if [ -d "projects/liljs-castle" ]; then
            echo "Building Lil J's Castle..."
            cd projects/liljs-castle

            # Try to build if castle-engine is available
            # If not, we'll use placeholder files that are already in repo
            if command -v castle-engine &> /dev/null; then
              castle-engine clean 2>/dev/null || true
              castle-engine compile --target=web --mode=release && \
                echo "‚úÖ Lil J's Castle built successfully" || \
                echo "‚ö†Ô∏è  Build failed, using placeholder files"
            else
              echo "‚ö†Ô∏è  castle-engine not available in CI - using placeholder"
              echo "   Build locally with: ./build-web.sh"
            fi

            cd ../..

            # Copy built files to web-deploy (if build succeeded)
            mkdir -p web-deploy/liljs-castle/game
            if [ -d "projects/liljs-castle/castle-engine-output/web/dist" ]; then
              cp -r projects/liljs-castle/castle-engine-output/web/dist/* web-deploy/liljs-castle/game/
              echo "‚úÖ Copied built files to web-deploy/"
            else
              echo "‚ÑπÔ∏è  Using placeholder files from repo"
            fi
          fi

          echo ""
          echo "üè∞ Building Fibonacci Castle Suite..."
          echo "œÜ = 1.618033988749..."

          # Build UniCastle (Game 1)
          if [ -d "projects/01-unicastle" ]; then
            echo "Building UniCastle (Fibonacci Game 1)..."
            cd projects/01-unicastle

            if command -v castle-engine &> /dev/null; then
              castle-engine clean 2>/dev/null || true
              castle-engine compile --target=web --mode=release && \
                echo "‚úÖ UniCastle built successfully" || \
                echo "‚ö†Ô∏è  Build failed, using placeholder files"

              cd ../..

              # Copy built files to web-deploy
              mkdir -p web-deploy/fibonacci-suite/01-unicastle/game
              if [ -d "projects/01-unicastle/castle-engine-output/web/dist" ]; then
                cp -r projects/01-unicastle/castle-engine-output/web/dist/* web-deploy/fibonacci-suite/01-unicastle/game/
                echo "‚úÖ UniCastle copied to web-deploy/"
              fi
            else
              echo "‚ö†Ô∏è  castle-engine not available in CI"
              echo "   Build locally with: ./build-fibonacci-suite.sh"
              cd ../..
            fi
          fi

          # Ensure suite hub page exists
          if [ ! -f "web-deploy/fibonacci-suite/index.html" ]; then
            echo "‚ö†Ô∏è  Suite hub page missing - will be created from repo"
          fi

          echo ""
          echo "üì¶ Games ready for deployment from repository"

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./web-deploy/
          server-dir: /public_html/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.github/**
          dangerous-clean-slate: false
          log-level: verbose

      - name: Notify deployment
        run: |
          echo ""
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Games deployed to vltrngames.com:"
          echo "   - https://vltrngames.com/liljs-castle/"
          echo "   - https://vltrngames.com/fibonacci-suite/ (üè∞ Fibonacci Castle Suite Hub)"
          echo "   - https://vltrngames.com/fibonacci-suite/01-unicastle/"
          echo ""
          echo "üìÅ Deployed via FTP (bypasses SSH firewall restrictions)"
          echo "‚è∞ Deployment time: $(date)"
          echo "œÜ = 1.618033988749... ‚ú®"

