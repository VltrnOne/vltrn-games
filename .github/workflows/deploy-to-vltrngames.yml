name: Deploy to vltrngames.com

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allows manual triggering

env:
  DEPLOY_URL: vltrngames.com

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          if [ -z "${{ secrets.DEPLOY_HOST }}" ]; then
            echo "‚ùå ERROR: DEPLOY_HOST secret is not set!"
            echo "Please set DEPLOY_HOST in GitHub Secrets"
            exit 1
          fi
          echo "Adding ${{ secrets.DEPLOY_HOST }} to known_hosts..."

          # Try standard port 22 first
          if ssh-keyscan -H -T 10 ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null; then
            echo "‚úÖ Host added successfully on port 22"
          # Try common SiteGround SSH port 18765
          elif ssh-keyscan -p 18765 -H -T 10 ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null; then
            echo "‚úÖ Host added successfully on port 18765"
          else
            echo "‚ö†Ô∏è Warning: Could not scan host, will use StrictHostKeyChecking=accept-new"
            echo "This is normal for some hosting providers"
          fi
          chmod 644 ~/.ssh/known_hosts 2>/dev/null || true

      - name: Build All Games from Repo
        run: |
          echo "üèóÔ∏è  Building VLTRN Games from repository..."
          echo "   (Same process as other games - builds from repo, deploys automatically)"
          echo ""

          # Build Lil J's Castle
          if [ -d "projects/liljs-castle" ]; then
            echo "Building Lil J's Castle..."
            cd projects/liljs-castle

            # Try to build if castle-engine is available
            # If not, we'll use placeholder files that are already in repo
            if command -v castle-engine &> /dev/null; then
              castle-engine clean 2>/dev/null || true
              castle-engine compile --target=web --mode=release && \
                echo "‚úÖ Lil J's Castle built successfully" || \
                echo "‚ö†Ô∏è  Build failed, using placeholder files"
            else
              echo "‚ö†Ô∏è  castle-engine not available in CI - using placeholder"
              echo "   Build locally with: ./build-web.sh"
            fi

            cd ../..

            # Copy built files to web-deploy (if build succeeded)
            mkdir -p web-deploy/liljs-castle/game
            if [ -d "projects/liljs-castle/castle-engine-output/web/dist" ]; then
              cp -r projects/liljs-castle/castle-engine-output/web/dist/* web-deploy/liljs-castle/game/
              echo "‚úÖ Copied built files to web-deploy/"
            else
              echo "‚ÑπÔ∏è  Using placeholder files from repo"
            fi
          fi

          echo ""
          echo "üè∞ Building Fibonacci Castle Suite..."
          echo "œÜ = 1.618033988749..."

          # Build UniCastle (Game 1)
          if [ -d "projects/01-unicastle" ]; then
            echo "Building UniCastle (Fibonacci Game 1)..."
            cd projects/01-unicastle

            if command -v castle-engine &> /dev/null; then
              castle-engine clean 2>/dev/null || true
              castle-engine compile --target=web --mode=release && \
                echo "‚úÖ UniCastle built successfully" || \
                echo "‚ö†Ô∏è  Build failed, using placeholder files"

              cd ../..

              # Copy built files to web-deploy
              mkdir -p web-deploy/fibonacci-suite/01-unicastle/game
              if [ -d "projects/01-unicastle/castle-engine-output/web/dist" ]; then
                cp -r projects/01-unicastle/castle-engine-output/web/dist/* web-deploy/fibonacci-suite/01-unicastle/game/
                echo "‚úÖ UniCastle copied to web-deploy/"
              fi
            else
              echo "‚ö†Ô∏è  castle-engine not available in CI"
              echo "   Build locally with: ./build-fibonacci-suite.sh"
              cd ../..
            fi
          fi

          # Ensure suite hub page exists
          if [ ! -f "web-deploy/fibonacci-suite/index.html" ]; then
            echo "‚ö†Ô∏è  Suite hub page missing - will be created from repo"
          fi

          echo ""
          echo "üì¶ Games ready for deployment from repository"

      - name: Deploy to server
        run: |
          echo "Deploying to ${{ secrets.DEPLOY_HOST }}..."

          # Determine SSH port (default 22, or use DEPLOY_PORT secret if set)
          SSH_PORT="${{ secrets.DEPLOY_PORT }}"
          SSH_PORT="${SSH_PORT:-22}"
          echo "Using SSH port: $SSH_PORT"

          # Deploy all games from web-deploy directory (same pattern as other games)
          rsync -avz --delete \
            -e "ssh -p $SSH_PORT -o StrictHostKeyChecking=accept-new" \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.github' \
            web-deploy/ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/web-deploy/
          
          # Create symlinks or copy to main site directories (matching other games pattern)
          ssh -p $SSH_PORT -o StrictHostKeyChecking=accept-new ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            echo "Setting up game directories..."

            # Lil J's Castle
            mkdir -p ${{ secrets.DEPLOY_PATH }}/liljs-castle
            cp -r ${{ secrets.DEPLOY_PATH }}/web-deploy/liljs-castle/* ${{ secrets.DEPLOY_PATH }}/liljs-castle/ 2>/dev/null || true

            # Fibonacci Castle Suite
            mkdir -p ${{ secrets.DEPLOY_PATH }}/fibonacci-suite
            cp -r ${{ secrets.DEPLOY_PATH }}/web-deploy/fibonacci-suite/* ${{ secrets.DEPLOY_PATH }}/fibonacci-suite/ 2>/dev/null || true

            echo ""
            echo "‚úÖ Deployment completed successfully!"
            echo "üåê Games deployed:"
            echo "   - https://vltrngames.com/liljs-castle/"
            echo "   - https://vltrngames.com/fibonacci-suite/ (üè∞ NEW!)"
            echo "   - https://vltrngames.com/fibonacci-suite/01-unicastle/"
            echo ""
            echo "üìÅ Files deployed from repository (auto-updates on push)"
            echo "œÜ = 1.618033988749... ‚ú®"
          EOF

      - name: Notify deployment
        run: |
          echo "‚úÖ Successfully deployed to vltrngames.com"
          echo "Deployment time: $(date)"

