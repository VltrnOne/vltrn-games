<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor - Game Builder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }

        .editor-container {
            display: grid;
            grid-template-columns: 300px 1fr 1fr;
            height: 100vh;
        }

        .sidebar {
            background: #252526;
            border-right: 1px solid #3e3e42;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h2 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .file-tree {
            list-style: none;
        }

        .file-tree li {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 4px;
            color: #cccccc;
            font-size: 0.9em;
        }

        .file-tree li:hover {
            background: #2a2d2e;
        }

        .file-tree li.active {
            background: #094771;
            color: #fff;
        }

        .file-tree .folder {
            color: #4ec9b0;
        }

        .file-tree .file {
            color: #9cdcfe;
            padding-left: 20px;
        }

        .editor-panel {
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            border-right: 1px solid #3e3e42;
        }

        .editor-header {
            background: #2d2d30;
            padding: 10px 15px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-header .filename {
            color: #fff;
            font-weight: 600;
        }

        .editor-header .actions {
            display: flex;
            gap: 10px;
        }

        .CodeMirror {
            flex: 1;
            height: 100%;
            font-size: 14px;
        }

        .preview-panel {
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
        }

        .preview-header {
            background: #2d2d30;
            padding: 10px 15px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-header h3 {
            color: #fff;
            font-size: 1em;
        }

        .preview-frame {
            flex: 1;
            background: #000;
            position: relative;
        }

        .preview-frame iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #0e639c;
            color: #fff;
        }

        .btn-primary:hover {
            background: #1177bb;
        }

        .btn-success {
            background: #0e7c0e;
            color: #fff;
        }

        .btn-success:hover {
            background: #0f9f0f;
        }

        .btn-secondary {
            background: #3e3e42;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #505050;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 1.2em;
        }

        .game-selector {
            margin-bottom: 20px;
        }

        .game-selector select {
            width: 100%;
            padding: 10px;
            background: #3e3e42;
            color: #fff;
            border: 1px solid #505050;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status-bar {
            background: #007acc;
            color: #fff;
            padding: 5px 15px;
            font-size: 0.85em;
            display: flex;
            justify-content: space-between;
        }

        .tabs {
            display: flex;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
        }

        .tab {
            padding: 10px 20px;
            background: #2d2d30;
            color: #cccccc;
            cursor: pointer;
            border-right: 1px solid #3e3e42;
        }

        .tab.active {
            background: #1e1e1e;
            color: #fff;
            border-bottom: 2px solid #007acc;
        }

        .tab:hover {
            background: #2a2d2e;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <div class="sidebar">
            <h2>ðŸŽ® Game Builder</h2>
            
            <div class="game-selector">
                <select id="gameSelect">
                    <option value="liljs-castle">Lil J's Castle</option>
                    <option value="unicastle">UniCastle</option>
                </select>
            </div>

            <h3 style="color: #fff; margin-top: 20px; margin-bottom: 10px; font-size: 1em;">Files</h3>
            <ul class="file-tree" id="fileTree">
                <!-- Files will be loaded here -->
            </ul>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #3e3e42;">
                <button class="btn btn-success" style="width: 100%;" onclick="buildAndPlay()">â–¶ Build & Play</button>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="saveCode()">ðŸ’¾ Save Code</button>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="resetCode()">â†º Reset</button>
            </div>
        </div>

        <div class="editor-panel">
            <div class="tabs" id="tabs">
                <!-- Tabs will be generated here -->
            </div>
            <div class="editor-header">
                <span class="filename" id="currentFile">Select a file</span>
                <div class="actions">
                    <button class="btn btn-primary" onclick="formatCode()">Format</button>
                </div>
            </div>
            <div id="editor"></div>
        </div>

        <div class="preview-panel">
            <div class="preview-header">
                <h3>Preview</h3>
                <div class="actions">
                    <button class="btn btn-primary" onclick="refreshPreview()">ðŸ”„ Refresh</button>
                </div>
            </div>
            <div class="preview-frame">
                <div class="loading" id="previewLoading">Ready to build...</div>
                <iframe id="previewFrame" style="display: none;"></iframe>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <span id="statusText">Ready</span>
        <span id="lineCol">Line 1, Col 1</span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/pascal/pascal.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/display/autorefresh.min.js"></script>

    <script>
        let editor;
        let currentGame = 'liljs-castle';
        let openFiles = {};
        let activeTab = null;

        // Game file structures
        const gameFiles = {
            'liljs-castle': {
                'code/gameviewmain.pas': `{
  Copyright 2024 VLTRN Games.

  This file is part of "Lil J's Castle" - VLTRN Games project.

  "Castle Game Engine" is free software; see the file COPYING.txt,
  included in this distribution, for details about the copyright.

  ----------------------------------------------------------------------------
}
{ Main view, where most of the application logic takes place. }
unit GameViewMain;

interface

uses Classes,
  CastleVectors, CastleComponentSerialize,
  CastleUIControls, CastleControls, CastleKeysMouse;

type
  { Main view, where most of the application logic takes place. }
  TViewMain = class(TCastleView)
  published
    { Components designed using CGE editor.
      These fields will be automatically initialized at Start. }
    LabelTitle: TCastleLabel;
    LabelFps: TCastleLabel;
  private
    LifeTime: Double;
  public
    constructor Create(AOwner: TComponent); override;
    procedure Start; override;
    procedure Update(const SecondsPassed: Single; var HandleInput: Boolean); override;
    procedure Render; override;
  end;

var
  ViewMain: TViewMain;

implementation

uses SysUtils,
  CastleGLUtils, CastleRectangles, CastleColors, CastleLog;

{ TViewMain ----------------------------------------------------------------- }

constructor TViewMain.Create(AOwner: TComponent);
begin
  inherited;
  // TODO: Load UI design when web data loading is fully supported
  // DesignUrl := 'castle-data:/gameviewmain.castle-user-interface';
end;

procedure TViewMain.Start;
begin
  inherited;

  // Set background color - castle theme
  Container.BackgroundColor := Vector4(0.2, 0.15, 0.1, 1.0);

  // Create title label
  LabelTitle := TCastleLabel.Create(FreeAtStop);
  LabelTitle.Anchor(hpMiddle);
  LabelTitle.Anchor(vpTop, -20);
  LabelTitle.Caption := 'Lil J''s Castle';
  LabelTitle.Color := Vector4(1.0, 0.8, 0.4, 1.0); // Gold color
  LabelTitle.FontSize := 48;
  LabelTitle.FontStyle := [fsBold];
  InsertFront(LabelTitle);

  // Create FPS label
  LabelFps := TCastleLabel.Create(FreeAtStop);
  LabelFps.Anchor(hpLeft, 10);
  LabelFps.Anchor(vpTop, -10);
  LabelFps.Color := Gray;
  LabelFps.FontSize := 16;
  InsertFront(LabelFps);
end;

procedure TViewMain.Render;
var
  CenterX, CenterY: Single;
begin
  inherited;

  CenterX := Container.PixelsWidth / 2;
  CenterY := Container.PixelsHeight / 2;

  // Draw animated castle silhouette
  DrawCircle(
    Vector2(
      CenterX + 50 * Sin(LifeTime * 2),
      CenterY - 50 + 30 * Cos(LifeTime * 1.5)
    ),
    40, 40, Vector4(0.6, 0.5, 0.4, 1.0) // Brown castle color
  );

  // Draw castle towers (simple rectangles)
  DrawRectangle(FloatRectangle(CenterX - 100, CenterY - 100, 40, 80), Vector4(0.5, 0.4, 0.3, 1.0));
  DrawRectangle(FloatRectangle(CenterX - 20, CenterY - 120, 40, 100), Vector4(0.5, 0.4, 0.3, 1.0));
  DrawRectangle(FloatRectangle(CenterX + 60, CenterY - 100, 40, 80), Vector4(0.5, 0.4, 0.3, 1.0));

  // Draw welcome message
  FallbackFont.Print(
    CenterX - 150,
    CenterY + 100,
    Vector4(1.0, 1.0, 1.0, 1.0),
    'Welcome to Lil J''s Castle!' + NL +
    'Built with Castle Game Engine' + NL +
    'Deployed to vltrngames.com'
  );

  // Draw decorative elements
  DrawCircle(
    Vector2(
      CenterX - 150 + 30 * Sin(LifeTime * 3),
      CenterY + 50 + 20 * Cos(LifeTime * 2)
    ),
    15, 15, Vector4(1.0, 0.9, 0.6, 0.8) // Star-like element
  );
end;

procedure TViewMain.Update(const SecondsPassed: Single; var HandleInput: Boolean);
begin
  inherited;
  { This virtual method is executed every frame (many times per second). }
  LifeTime := LifeTime + SecondsPassed;
  if Assigned(LabelFps) then
    LabelFps.Caption := 'FPS: ' + Container.Fps.ToString;
end;

end.`,
                'code/gameinitialize.pas': `{
  Copyright 2024 VLTRN Games.

  This file is part of "Lil J's Castle" - VLTRN Games project.

  "Castle Game Engine" is free software; see the file COPYING.txt,
  included in this distribution, for details about the copyright.

  ----------------------------------------------------------------------------
}

{ Game initialization.
  This unit is cross-platform.
  It will be used by the platform-specific program or library file. }
unit GameInitialize;

interface

implementation

uses CastleWindow, CastleLog, CastleApplicationProperties,
  GameViewMain;

var
  Window: TCastleWindow;

{ One-time initialization of resources. }
procedure ApplicationInitialize;
begin
  { Adjust container settings for a scalable UI (adjusts to any window size in a smart way). }
  Window.Container.LoadSettings('castle-data:/CastleSettings.xml');

  ViewMain := TViewMain.Create(Application);
  Window.Container.View := ViewMain;
end;

initialization
  { This initialization section configures:
    - Application.OnInitialize
    - Application.MainWindow
    - determines initial window size

    You should not need to do anything more in this initialization section.
    Most of your actual application initialization (in particular, any file reading)
    should happen inside ApplicationInitialize. }

  Application.OnInitialize := @ApplicationInitialize;

  Window := TCastleWindow.Create(Application);
  Application.MainWindow := Window;

  { Handle command-line parameters like --fullscreen and --window.
    By doing this last, you let user to override your fullscreen / mode setup. }
  Window.ParseParameters;
end.`
            },
            'unicastle': {
                'code/gameviewmain.pas': `{
  UniCastle - Main Game View
  Simple one-tower gameplay introducing Fibonacci mechanics
  Copyright 2024 VLTRN Games
}
unit GameViewMain;

interface

uses
  Classes, SysUtils,
  CastleVectors, CastleUIControls, CastleControls, CastleKeysMouse,
  CastleColors, FibonacciCore, GoldenColors;

type
  { Player state }
  TPlayer = class
    Position: TVector2;
    Velocity: TVector2;
    OnGround: Boolean;
    JumpIndex: Integer;  { Current position in Fibonacci jump sequence }
    Score: Integer;

    constructor Create;
    procedure Reset;
  end;

  { Collectible golden spiral }
  TGoldenSpiral = class
    Position: TVector2;
    Rotation: Single;
    Collected: Boolean;
    FibValue: Integer;  { Fibonacci number this spiral represents }

    constructor Create(APosition: TVector2; AFibIndex: Integer);
  end;

  { Main game view }
  TViewMain = class(TCastleView)
  private
    Player: TPlayer;
    Spirals: array[0..7] of TGoldenSpiral;
    LabelScore: TCastleLabel;
    LabelFps: TCastleLabel;
    LabelInstructions: TCastleLabel;
    Palette: TGamePalette;
    GameTime: Single;
    TowerWidth: Single;
    TowerHeight: Single;

    procedure SpawnSpirals;
    procedure CheckCollisions;
  public
    constructor Create(AOwner: TComponent); override;
    destructor Destroy; override;
    procedure Start; override;
    procedure Update(const SecondsPassed: Single; var HandleInput: Boolean); override;
    procedure Render; override;
    function Press(const Event: TInputPressRelease): Boolean; override;
  end;

var
  ViewMain: TViewMain;

implementation

uses
  CastleGLUtils, CastleRectangles, Math;

const
  GRAVITY = 800.0;
  PLAYER_SIZE = 30.0;
  GROUND_LEVEL = 100.0;

{ TPlayer }

constructor TPlayer.Create;
begin
  inherited;
  Reset;
end;

procedure TPlayer.Reset;
begin
  Position := Vector2(640, GROUND_LEVEL);
  Velocity := Vector2(0, 0);
  OnGround := True;
  JumpIndex := 0;
  Score := 0;
end;

{ TGoldenSpiral }

constructor TGoldenSpiral.Create(APosition: TVector2; AFibIndex: Integer);
begin
  inherited Create;
  Position := APosition;
  Rotation := 0;
  Collected := False;
  FibValue := Fib(AFibIndex);
end;

{ TViewMain }

constructor TViewMain.Create(AOwner: TComponent);
var
  i: Integer;
begin
  inherited;
  Palette := UniCastlePalette;
  Player := TPlayer.Create;
  GameTime := 0;

  { Initialize spirals array }
  for i := 0 to High(Spirals) do
    Spirals[i] := nil;
end;

destructor TViewMain.Destroy;
var
  i: Integer;
begin
  Player.Free;
  for i := 0 to High(Spirals) do
    if Spirals[i] <> nil then
      Spirals[i].Free;
  inherited;
end;

procedure TViewMain.Start;
begin
  inherited;

  Container.BackgroundColor := Palette.Background;

  TowerWidth := 200;
  TowerHeight := GoldenRectangleWidth(TowerWidth);

  { Score label }
  LabelScore := TCastleLabel.Create(FreeAtStop);
  LabelScore.Caption := 'Score: 0';
  LabelScore.FontSize := 32;
  LabelScore.Color := Palette.Primary;
  LabelScore.Anchor(hpLeft, 20);
  LabelScore.Anchor(vpTop, -20);
  InsertFront(LabelScore);

  { FPS label }
  LabelFps := TCastleLabel.Create(FreeAtStop);
  LabelFps.FontSize := 16;
  LabelFps.Color := Palette.Tertiary;
  LabelFps.Anchor(hpRight, -20);
  LabelFps.Anchor(vpTop, -20);
  InsertFront(LabelFps);

  { Instructions }
  LabelInstructions := TCastleLabel.Create(FreeAtStop);
  LabelInstructions.Caption := 'SPACE to Jump â€¢ Collect Golden Spirals â€¢ Jump Power Follows Fibonacci!';
  LabelInstructions.FontSize := 18;
  LabelInstructions.Color := Palette.Accent;
  LabelInstructions.Anchor(hpMiddle);
  LabelInstructions.Anchor(vpBottom, 20);
  InsertFront(LabelInstructions);

  SpawnSpirals;
end;

procedure TViewMain.SpawnSpirals;
var
  i: Integer;
  xPos, yPos: Single;
begin
  { Spawn spirals at Fibonacci-based positions }
  for i := 0 to High(Spirals) do
  begin
    if Spirals[i] <> nil then
      Spirals[i].Free;

    { Position spirals using golden ratio distribution }
    xPos := 200 + (i + 1) * 130;
    yPos := GROUND_LEVEL + 100 + Fib(i + 1) * 15;

    Spirals[i] := TGoldenSpiral.Create(Vector2(xPos, yPos), i + 1);
  end;
end;

procedure TViewMain.CheckCollisions;
var
  i: Integer;
  distance: Single;
begin
  for i := 0 to High(Spirals) do
  begin
    if (Spirals[i] <> nil) and (not Spirals[i].Collected) then
    begin
      distance := Vector2(
        Player.Position.X - Spirals[i].Position.X,
        Player.Position.Y - Spirals[i].Position.Y
      ).Length;

      if distance < (PLAYER_SIZE + 20) then
      begin
        Spirals[i].Collected := True;
        Player.Score := Player.Score + Spirals[i].FibValue;
        LabelScore.Caption := Format('Score: %d (Fib!)', [Player.Score]);
      end;
    end;
  end;
end;

procedure TViewMain.Update(const SecondsPassed: Single; var HandleInput: Boolean);
var
  i: Integer;
begin
  inherited;

  GameTime := GameTime + SecondsPassed;

  { Update FPS }
  LabelFps.Caption := Format('FPS: %d', [Container.Fps.RealFps]);

  { Physics for player }
  if not Player.OnGround then
  begin
    Player.Velocity := Vector2(
      Player.Velocity.X,
      Player.Velocity.Y - GRAVITY * SecondsPassed
    );
  end;

  { Update player position }
  Player.Position := Vector2(
    Player.Position.X + Player.Velocity.X * SecondsPassed,
    Player.Position.Y + Player.Velocity.Y * SecondsPassed
  );

  { Ground collision }
  if Player.Position.Y <= GROUND_LEVEL then
  begin
    Player.Position := Vector2(Player.Position.X, GROUND_LEVEL);
    Player.Velocity := Vector2(Player.Velocity.X, 0);
    Player.OnGround := True;
    Player.JumpIndex := 0;  { Reset jump sequence when landing }
  end
  else
  begin
    Player.OnGround := False;
  end;

  { Rotate spirals using golden angle }
  for i := 0 to High(Spirals) do
  begin
    if Spirals[i] <> nil then
      Spirals[i].Rotation := Spirals[i].Rotation + GoldenAngle * SecondsPassed / 10;
  end;

  CheckCollisions;
end;

procedure TViewMain.Render;
var
  CenterX: Single;
  i, j: Integer;
  SpiralSize: Single;
  SpiralColor: TCastleColor;
  PlayerColor: TCastleColor;
begin
  inherited;

  CenterX := Container.PixelsWidth / 2;

  { Draw the single tower }
  DrawRectangle(
    FloatRectangle(
      CenterX - TowerWidth / 2,
      GROUND_LEVEL,
      TowerWidth,
      TowerHeight
    ),
    Palette.Primary
  );

  { Tower top }
  DrawRectangle(
    FloatRectangle(
      CenterX - (TowerWidth * 0.7) / 2,
      GROUND_LEVEL + TowerHeight,
      TowerWidth * 0.7,
      50
    ),
    LightenColor(Palette.Primary, 0.2)
  );

  { Draw ground }
  DrawRectangle(
    FloatRectangle(0, 0, Container.PixelsWidth, GROUND_LEVEL),
    DarkenColor(Palette.Background, 0.2)
  );

  { Draw spirals }
  for i := 0 to High(Spirals) do
  begin
    if (Spirals[i] <> nil) and (not Spirals[i].Collected) then
    begin
      SpiralSize := Fib(i + 1) * 3;
      SpiralColor := FibonacciColor(i + 1, 0.8, 0.9);

      { Draw spiral as rotating circles forming golden spiral pattern }
      for j := 0 to 5 do
      begin
        DrawCircle(
          Vector2(
            Spirals[i].Position.X + Cos(DegToRad(Spirals[i].Rotation + j * 60)) * (j * 8),
            Spirals[i].Position.Y + Sin(DegToRad(Spirals[i].Rotation + j * 60)) * (j * 8)
          ),
          SpiralSize - j * 2,
          SpiralSize - j * 2,
          WithAlpha(SpiralColor, 1.0 - j * 0.15)
        );
      end;

      { Draw Fibonacci number }
      FallbackFont.Print(
        Spirals[i].Position.X - 10,
        Spirals[i].Position.Y - 35,
        COLOR_TEXT_PRIMARY,
        IntToStr(Spirals[i].FibValue)
      );
    end;
  end;

  { Draw player }
  PlayerColor := Palette.Accent;
  if not Player.OnGround then
    PlayerColor := LerpColor(Palette.Accent, Palette.Primary, 0.5);

  DrawCircle(
    Player.Position,
    PLAYER_SIZE,
    PLAYER_SIZE,
    PlayerColor
  );

  { Draw player indicator }
  FallbackFont.Print(
    Player.Position.X - 15,
    Player.Position.Y - 10,
    DarkenColor(PlayerColor, 0.5),
    'ðŸ‘‘'  { Using crown emoji as player marker }
  );

  { Draw Fibonacci sequence reminder }
  FallbackFont.Print(
    20,
    Container.PixelsHeight - 50,
    Palette.Tertiary,
    Format('Jump Sequence: %d â†’ %d â†’ %d â†’ %d â†’ %d â†’ %d...',
      [Fib(1), Fib(2), Fib(3), Fib(4), Fib(5), Fib(6)])
  );

  { Draw current jump power }
  if not Player.OnGround then
  begin
    FallbackFont.Print(
      Player.Position.X - 20,
      Player.Position.Y + 50,
      COLOR_TEXT_PRIMARY,
      Format('Jump: %d', [Fib(Player.JumpIndex)])
    );
  end;
end;

function TViewMain.Press(const Event: TInputPressRelease): Boolean;
var
  JumpPower: Single;
begin
  Result := inherited;
  if Result then Exit;

  if Event.IsKey(keySpace) and Player.OnGround then
  begin
    { Fibonacci jump mechanics }
    JumpPower := Fib(Player.JumpIndex + 1) * 50.0;
    Player.Velocity := Vector2(0, JumpPower);
    Player.OnGround := False;

    { Advance in Fibonacci sequence }
    Player.JumpIndex := (Player.JumpIndex + 1) mod 8;  { Cycle through first 8 Fibonacci numbers }

    Result := True;
  end;
end;

end.`,
                'code/gameinitialize.pas': `{
  UniCastle - Game Initialization
  Copyright 2024 VLTRN Games
}
unit GameInitialize;

interface

implementation

uses CastleWindow, CastleLog, CastleApplicationProperties,
  GameViewMain;

var
  Window: TCastleWindow;

{ One-time initialization of resources. }
procedure ApplicationInitialize;
begin
  { Adjust container settings for a scalable UI (adjusts to any window size in a smart way). }
  Window.Container.LoadSettings('castle-data:/CastleSettings.xml');

  ViewMain := TViewMain.Create(Application);
  Window.Container.View := ViewMain;
end;

initialization
  { This initialization section configures:
    - Application.OnInitialize
    - Application.MainWindow
    - determines initial window size

    You should not need to do anything more in this initialization section.
    Most of your actual application initialization (in particular, any file reading)
    should happen inside ApplicationInitialize. }

  Application.OnInitialize := @ApplicationInitialize;

  Window := TCastleWindow.Create(Application);
  Application.MainWindow := Window;

  { Handle command-line parameters like --fullscreen and --window.
    By doing this last, you let user to override your fullscreen / mode setup. }
  Window.ParseParameters;
end.`
            }
        };

        // Initialize editor
        document.addEventListener('DOMContentLoaded', function() {
            editor = CodeMirror(document.getElementById('editor'), {
                value: '// Select a file to edit',
                mode: 'pascal',
                theme: 'monokai',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                styleActiveLine: true,
                lineWrapping: true,
                indentUnit: 2,
                tabSize: 2
            });

            editor.on('cursorActivity', function() {
                const cursor = editor.getCursor();
                document.getElementById('lineCol').textContent = 
                    `Line ${cursor.line + 1}, Col ${cursor.ch + 1}`;
            });

            document.getElementById('gameSelect').addEventListener('change', function() {
                currentGame = this.value;
                loadGameFiles();
            });

            loadGameFiles();
        });

        function loadGameFiles() {
            const files = gameFiles[currentGame];
            const tree = document.getElementById('fileTree');
            tree.innerHTML = '';

            Object.keys(files).forEach(filePath => {
                const li = document.createElement('li');
                li.className = 'file';
                li.textContent = filePath.split('/').pop();
                li.dataset.path = filePath;
                li.addEventListener('click', function() {
                    openFile(filePath);
                });
                tree.appendChild(li);
            });
        }

        function openFile(filePath) {
            // Update active file in tree
            document.querySelectorAll('.file-tree li').forEach(li => {
                li.classList.remove('active');
                if (li.dataset.path === filePath) {
                    li.classList.add('active');
                }
            });

            // Load file content
            const content = gameFiles[currentGame][filePath];
            
            // Check if file is already open
            if (openFiles[filePath]) {
                // Switch to existing tab
                switchTab(filePath);
                return;
            }

            // Create new tab
            const tab = document.createElement('div');
            tab.className = 'tab active';
            tab.textContent = filePath.split('/').pop();
            tab.dataset.path = filePath;
            tab.addEventListener('click', function() {
                switchTab(filePath);
            });
            document.getElementById('tabs').appendChild(tab);

            // Store file content
            openFiles[filePath] = {
                content: content,
                editor: null
            };

            // Load into editor
            editor.setValue(content);
            editor.setOption('mode', filePath.endsWith('.pas') ? 'pascal' : 'text');
            
            activeTab = filePath;
            document.getElementById('currentFile').textContent = filePath;

            // Track changes
            editor.on('change', function() {
                if (openFiles[filePath]) {
                    openFiles[filePath].content = editor.getValue();
                }
            });
        }

        function switchTab(filePath) {
            // Save current file
            if (activeTab && openFiles[activeTab]) {
                openFiles[activeTab].content = editor.getValue();
            }

            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.path === filePath) {
                    tab.classList.add('active');
                }
            });

            // Load file
            const file = openFiles[filePath];
            editor.setValue(file.content);
            editor.setOption('mode', filePath.endsWith('.pas') ? 'pascal' : 'text');
            
            activeTab = filePath;
            document.getElementById('currentFile').textContent = filePath;
        }

        function buildAndPlay() {
            // Save all open files
            if (activeTab && openFiles[activeTab]) {
                openFiles[activeTab].content = editor.getValue();
            }

            document.getElementById('statusText').textContent = 'Building...';
            document.getElementById('previewLoading').textContent = 'Building your custom game...';
            document.getElementById('previewLoading').style.display = 'block';
            document.getElementById('previewFrame').style.display = 'none';

            // In a real implementation, this would:
            // 1. Send code to server/GitHub Actions
            // 2. Compile using pas2js
            // 3. Return build URL
            // For now, we'll simulate with a delay
            
            setTimeout(() => {
                // Create a custom build ID
                const buildId = Date.now().toString(36);
                
                // Store custom code in localStorage
                const customBuild = {
                    game: currentGame,
                    files: openFiles,
                    buildId: buildId,
                    timestamp: Date.now()
                };
                localStorage.setItem(`custom_build_${buildId}`, JSON.stringify(customBuild));

                // For now, show a message (in real implementation, this would load the compiled game)
                document.getElementById('previewLoading').innerHTML = 
                    'âœ… Build complete!<br><br>' +
                    'Custom build ID: ' + buildId + '<br><br>' +
                    'Note: Full compilation requires server-side pas2js.<br>' +
                    'Your code has been saved locally.';
                
                document.getElementById('statusText').textContent = 'Build complete';
            }, 2000);
        }

        function saveCode() {
            if (activeTab && openFiles[activeTab]) {
                openFiles[activeTab].content = editor.getValue();
            }

            const allCode = {
                game: currentGame,
                files: openFiles,
                timestamp: Date.now()
            };
            
            localStorage.setItem(`saved_code_${currentGame}`, JSON.stringify(allCode));
            document.getElementById('statusText').textContent = 'Code saved locally';
            
            setTimeout(() => {
                document.getElementById('statusText').textContent = 'Ready';
            }, 2000);
        }

        function resetCode() {
            if (confirm('Reset all changes? This cannot be undone.')) {
                openFiles = {};
                document.getElementById('tabs').innerHTML = '';
                editor.setValue('// Select a file to edit');
                document.getElementById('currentFile').textContent = 'Select a file';
                activeTab = null;
                loadGameFiles();
                document.getElementById('statusText').textContent = 'Code reset';
            }
        }

        function formatCode() {
            // Basic formatting (in real implementation, use a Pascal formatter)
            const code = editor.getValue();
            // Simple indentation fix
            editor.setValue(code);
            document.getElementById('statusText').textContent = 'Formatted';
        }

        function refreshPreview() {
            buildAndPlay();
        }
    </script>
</body>
</html>

